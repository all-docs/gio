<!--
SPDX-FileCopyrightText: GLib Development Team

SPDX-License-Identifier: LGPL-2.1-or-later
--><!DOCTYPE html><html lang="en"><!-- Mirrored from docs.gtk.org/gio/migrating-gdbus.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 31 Jan 2025 08:38:15 GMT --><!-- Added by HTTrack --><head><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->

  <title>Gio – 2.0: Migrating to GDBus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta charset="utf-8">

  
  <meta property="og:type" content="website">

  

  
  <meta property="og:title" content="Gio: Migrating to GDBus">
  <meta property="og:description" content="Reference for Gio-2.0: Migrating to GDBus">
  <meta name="twitter:title" content="Gio: Migrating to GDBus">
  <meta name="twitter:description" content="Reference for Gio-2.0: Migrating to GDBus">


  
  <meta name="twitter:card" content="summary">

  
  
  
  

  <link rel="stylesheet" href="style.css" type="text/css">

  

  
  <script src="urlmap.js"></script>
  
  
  <script src="fzy.js"></script>
  <script src="search.js"></script>
  
  <script src="main.js"></script>

  
</head>

<body>
  <div id="body-wrapper" tabindex="-1">

    

    

    
<section id="main" class="content">
  
  <h4 id="title" style="display:flex;">
    Migrating to GDBus
    <a href="#title" class="anchor"></a>
    
  </h4>
  
  <section>
    <div class="docblock">
    <h1 id="migrating-to-gdbus">Migrating to GDBus<a class="md-anchor" href="#migrating-to-gdbus" title="Permanent link"></a></h1>
<h2 id="conceptual-differences">Conceptual differences<a class="md-anchor" href="#conceptual-differences" title="Permanent link"></a></h2>
<p>The central concepts of D-Bus are modelled in a very similar way in
dbus-glib and GDBus. Both have objects representing connections, proxies and
method invocations. But there are some important&nbsp;differences:</p>
<ul>
<li>dbus-glib uses the libdbus reference implementation, GDBus doesn’t.
  Instead, it relies on <span class="caps">GIO</span> streams as transport layer, and has its own
  implementation for the D-Bus connection setup and authentication. Apart
  from using streams as transport, avoiding libdbus also lets GDBus avoid
  some thorny multithreading&nbsp;issues.</li>
<li>dbus-glib uses the GObject type system for method arguments and return
  values, including a homegrown container specialization mechanism. GDBus
  relies on the GVariant type system which is explicitly designed to match
  D-Bus&nbsp;types.</li>
<li>dbus-glib models only D-Bus interfaces and does not provide any types for
  objects. GDBus models both D-Bus interfaces (via the GDBusInterface,
  GDBusProxy and GDBusInterfaceSkeleton types) and objects (via the
  GDBusObject, GDBusObjectSkeleton and GDBusObjectProxy&nbsp;types).</li>
<li>GDBus includes native support for the org.freedesktop.DBus.Properties (via
  the GDBusProxy type) and org.freedesktop.DBus.ObjectManager D-Bus
  interfaces, dbus-glib&nbsp;doesn’t.</li>
<li>The typical way to export an object in dbus-glib involves generating glue
  code from <span class="caps">XML</span> introspection data using dbus-binding-tool. GDBus provides a
  similar tool called gdbus-codegen that can also generate Docbook D-Bus
  interface&nbsp;documentation.</li>
<li>dbus-glib doesn’t provide any convenience <span class="caps">API</span> for owning and watching bus
  names, GDBus provides the <code>g_bus_own_name()</code> and <code>g_bus_watch_name()</code>
  family of convenience&nbsp;functions.</li>
<li>GDBus provides <span class="caps">API</span> to parse, generate and work with Introspection <span class="caps">XML</span>,
  dbus-glib&nbsp;doesn’t.</li>
<li>GTestDBus provides <span class="caps">API</span> to create isolated unit&nbsp;tests</li>
</ul>
<h2 id="api-comparison">API comparison<a class="md-anchor" href="#api-comparison" title="Permanent link"></a></h2>
<table>
<thead>
<tr>
<th>dbus-glib</th>
<th>GDBus</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DBusGConnection</code></td>
<td><code>GDBusConnection</code></td>
</tr>
<tr>
<td><code>DBusGProxy</code></td>
<td><code>GDBusProxy</code>, <code>GDBusInterface</code> - also see <code>GDBusObjectProxy</code></td>
</tr>
<tr>
<td><code>DBusGObject</code></td>
<td><code>GDBusInterfaceSkeleton</code>, <code>GDBusInterface</code> - also see <code>GDBusObjectSkeleton</code></td>
</tr>
<tr>
<td><code>DBusGMethodInvocation</code></td>
<td><code>GDBusMethodInvocation</code></td>
</tr>
<tr>
<td><code>dbus_g_bus_get()</code></td>
<td><code>g_bus_get_sync()</code>, also see <code>g_bus_get()</code></td>
</tr>
<tr>
<td><code>dbus_g_proxy_new_for_name()</code></td>
<td><code>g_dbus_proxy_new_sync()</code> and <code>g_dbus_proxy_new_for_bus_sync()</code>, also see <code>g_dbus_proxy_new()</code></td>
</tr>
<tr>
<td><code>dbus_g_proxy_add_signal()</code></td>
<td>not needed, use the generic “g-signal”</td>
</tr>
<tr>
<td><code>dbus_g_proxy_connect_signal()</code></td>
<td>use <code>g_signal_connect()</code> with “g-signal”</td>
</tr>
<tr>
<td><code>dbus_g_connection_register_g_object()</code></td>
<td><code>g_dbus_connection_register_object()</code> - also see <code>g_dbus_object_manager_server_export()</code></td>
</tr>
<tr>
<td><code>dbus_g_connection_unregister_g_object()</code></td>
<td><code>g_dbus_connection_unregister_object()</code> - also see <code>g_dbus_object_manager_server_unexport()</code></td>
</tr>
<tr>
<td><code>dbus_g_object_type_install_info()</code></td>
<td>introspection data is installed while registering an object, see <code>g_dbus_connection_register_object()</code></td>
</tr>
<tr>
<td><code>dbus_g_proxy_begin_call()</code></td>
<td><code>g_dbus_proxy_call()</code></td>
</tr>
<tr>
<td><code>dbus_g_proxy_end_call()</code></td>
<td><code>g_dbus_proxy_call_finish()</code></td>
</tr>
<tr>
<td><code>dbus_g_proxy_call()</code></td>
<td><code>g_dbus_proxy_call_sync()</code></td>
</tr>
<tr>
<td><code>dbus_g_error_domain_register()</code></td>
<td><code>g_dbus_error_register_error_domain()</code></td>
</tr>
<tr>
<td><code>dbus_g_error_has_name()</code></td>
<td>no direct equivalent, see <code>g_dbus_error_get_remote_error()</code></td>
</tr>
<tr>
<td><code>dbus_g_method_return()</code></td>
<td><code>g_dbus_method_invocation_return_value()</code></td>
</tr>
<tr>
<td><code>dbus_g_method_return_error()</code></td>
<td><code>g_dbus_method_invocation_return_error()</code> and variants</td>
</tr>
<tr>
<td><code>dbus_g_method_get_sender()</code></td>
<td><code>g_dbus_method_invocation_get_sender()</code></td>
</tr>
</tbody>
</table>
<h2 id="owning-bus-names">Owning bus names<a class="md-anchor" href="#owning-bus-names" title="Permanent link"></a></h2>
<p>Using dbus-glib, you typically call RequestName manually to own a name, like in the following&nbsp;excerpt:</p>
<div class="codehilite"><pre><span></span><code><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dbus_g_proxy_call</span><span class="w"> </span><span class="p">(</span><span class="n">system_bus_proxy</span><span class="p">,</span>
<span class="w">                         </span><span class="s">"RequestName"</span><span class="p">,</span>
<span class="w">                         </span><span class="o">&amp;</span><span class="n">error</span><span class="p">,</span>
<span class="w">                         </span><span class="n">G_TYPE_STRING</span><span class="p">,</span><span class="w"> </span><span class="n">NAME_TO_CLAIM</span><span class="p">,</span>
<span class="w">                         </span><span class="n">G_TYPE_UINT</span><span class="p">,</span><span class="w">   </span><span class="n">DBUS_NAME_FLAG_ALLOW_REPLACEMENT</span><span class="p">,</span>
<span class="w">                         </span><span class="n">G_TYPE_INVALID</span><span class="p">,</span>
<span class="w">                         </span><span class="n">G_TYPE_UINT</span><span class="p">,</span><span class="w">   </span><span class="o">&amp;</span><span class="n">result</span><span class="p">,</span>
<span class="w">                         </span><span class="n">G_TYPE_INVALID</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="n">g_warning</span><span class="w"> </span><span class="p">(</span><span class="s">"Failed to acquire %s: %s"</span><span class="p">,</span>
<span class="w">                   </span><span class="n">NAME_TO_CLAIM</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
<span class="w">        </span><span class="n">g_error_free</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="n">g_warning</span><span class="w"> </span><span class="p">(</span><span class="s">"Failed to acquire %s"</span><span class="p">,</span><span class="w"> </span><span class="n">NAME_TO_CLAIM</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DBUS_REQUEST_NAME_REPLY_PRIMARY_OWNER</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="n">g_warning</span><span class="w"> </span><span class="p">(</span><span class="s">"Failed to acquire %s: %s"</span><span class="p">,</span>
<span class="w">                   </span><span class="n">NAME_TO_CLAIM</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
<span class="w">        </span><span class="n">g_error_free</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="n">g_warning</span><span class="w"> </span><span class="p">(</span><span class="s">"Failed to acquire %s"</span><span class="p">,</span><span class="w"> </span><span class="n">NAME_TO_CLAIM</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="n">exit</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="n">dbus_g_proxy_add_signal</span><span class="w"> </span><span class="p">(</span><span class="n">system_bus_proxy</span><span class="p">,</span><span class="w"> </span><span class="s">"NameLost"</span><span class="p">,</span>
<span class="w">                         </span><span class="n">G_TYPE_STRING</span><span class="p">,</span><span class="w"> </span><span class="n">G_TYPE_INVALID</span><span class="p">);</span>
<span class="n">dbus_g_proxy_connect_signal</span><span class="w"> </span><span class="p">(</span><span class="n">system_bus_proxy</span><span class="p">,</span><span class="w"> </span><span class="s">"NameLost"</span><span class="p">,</span>
<span class="w">                             </span><span class="n">G_CALLBACK</span><span class="w"> </span><span class="p">(</span><span class="n">on_name_lost</span><span class="p">),</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/* further setup ... */</span>
</code></pre></div>

<p>While you can do things this way with GDBus too, using
<code>g_dbus_proxy_call_sync()</code>, it is much nicer to use the high-level <span class="caps">API</span> for&nbsp;this:</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">on_name_acquired</span><span class="w"> </span><span class="p">(</span><span class="n">GDBusConnection</span><span class="w"> </span><span class="o">*</span><span class="n">connection</span><span class="p">,</span>
<span class="w">                  </span><span class="k">const</span><span class="w"> </span><span class="n">gchar</span><span class="w">     </span><span class="o">*</span><span class="n">name</span><span class="p">,</span>
<span class="w">                  </span><span class="n">gpointer</span><span class="w">         </span><span class="n">user_data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="cm">/* further setup ... */</span>
<span class="p">}</span>

<span class="cm">/* ... */</span>

<span class="w">  </span><span class="n">owner_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_bus_own_name</span><span class="w"> </span><span class="p">(</span><span class="n">G_BUS_TYPE_SYSTEM</span><span class="p">,</span>
<span class="w">                             </span><span class="n">NAME_TO_CLAIM</span><span class="p">,</span>
<span class="w">                             </span><span class="n">G_BUS_NAME_OWNER_FLAGS_ALLOW_REPLACEMENT</span><span class="p">,</span>
<span class="w">                             </span><span class="n">on_bus_acquired</span><span class="p">,</span>
<span class="w">                             </span><span class="n">on_name_acquired</span><span class="p">,</span>
<span class="w">                             </span><span class="n">on_name_lost</span><span class="p">,</span>
<span class="w">                             </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">                             </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">  </span><span class="n">g_main_loop_run</span><span class="w"> </span><span class="p">(</span><span class="n">loop</span><span class="p">);</span>

<span class="w">  </span><span class="n">g_bus_unown_name</span><span class="w"> </span><span class="p">(</span><span class="n">owner_id</span><span class="p">);</span>
</code></pre></div>

<p>Note that <code>g_bus_own_name()</code> works asynchronously and requires you to enter
your mainloop to await the <code>on_name_acquired()</code> callback. Also note that in
order to avoid race conditions (e.g. when your service is activated by a
method call), you have to export your manager object before acquiring the
name. The <code>on_bus_acquired()</code> callback is the right place to do such&nbsp;preparations.</p>
<h2 id="creating-proxies-for-well-known-names">Creating proxies for well-known names<a class="md-anchor" href="#creating-proxies-for-well-known-names" title="Permanent link"></a></h2>
<p>dbus-glib lets you create proxy objects for well-known names, like the following&nbsp;example:</p>
<div class="codehilite"><pre><span></span><code><span class="n">proxy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dbus_g_proxy_new_for_name</span><span class="w"> </span><span class="p">(</span><span class="n">system_bus_connection</span><span class="p">,</span>
<span class="w">                                   </span><span class="s">"org.freedesktop.Accounts"</span><span class="p">,</span>
<span class="w">                                   </span><span class="s">"/org/freedesktop/Accounts"</span><span class="p">,</span>
<span class="w">                                   </span><span class="s">"org.freedesktop.Accounts"</span><span class="p">);</span>
</code></pre></div>

<p>For a DBusGProxy constructed like this, method calls will be sent to the current owner of the name, and that owner can change over&nbsp;time.</p>
<p>The same can be achieved with&nbsp;GDBusProxy:</p>
<div class="codehilite"><pre><span></span><code><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="n">proxy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_dbus_proxy_new_for_bus_sync</span><span class="w"> </span><span class="p">(</span><span class="n">G_BUS_TYPE_SYSTEM</span><span class="p">,</span>
<span class="w">                                       </span><span class="n">G_DBUS_PROXY_FLAGS_NONE</span><span class="p">,</span>
<span class="w">                                       </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="cm">/* GDBusInterfaceInfo */</span>
<span class="w">                                       </span><span class="s">"org.freedesktop.Accounts"</span><span class="p">,</span>
<span class="w">                                       </span><span class="s">"/org/freedesktop/Accounts"</span><span class="p">,</span>
<span class="w">                                       </span><span class="s">"org.freedesktop.Accounts"</span><span class="p">,</span>
<span class="w">                                       </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="cm">/* GCancellable */</span>
<span class="w">                                       </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
</code></pre></div>

<p>For an added layer of safety, you can specify what D-Bus interface the proxy
is expected to conform to by using the GDBusInterfaceInfo type.
Additionally, GDBusProxy loads, caches and tracks changes to the D-Bus
properties on the remote object. It also sets up match rules so D-Bus
signals from the remote object are delivered&nbsp;locally.</p>
<p>The GDBusProxy type normally isn’t used directly - instead proxies
subclassing GDBusProxy generated by <code>gdbus-codegen</code> is used, see the section
called “Using&nbsp;gdbus-codegen”.</p>
<h2 id="generating-code-and-docs">Generating code and docs<a class="md-anchor" href="#generating-code-and-docs" title="Permanent link"></a></h2>
<h3 id="using-gdbus-codegen">Using gdbus-codegen<a class="md-anchor" href="#using-gdbus-codegen" title="Permanent link"></a></h3>
<p>dbus-glib comes with dbus-binding-tool, which can produce somewhat nice
client- and server-side wrappers for a D-Bus interface. With GDBus,
gdbus-codegen is used and like its counterpart, it also takes D-Bus
Introspection <span class="caps">XML</span> as&nbsp;input:</p>
<h4 id="example-d-bus-introspection-xml">Example D-Bus Introspection XML<a class="md-anchor" href="#example-d-bus-introspection-xml" title="Permanent link"></a></h4>
<div class="codehilite"><pre><span></span><code><span class="nt">&lt;node&gt;</span>
<span class="w">  </span><span class="cm">&lt;!-- org.gtk.GDBus.Example.ObjectManager.Animal:</span>
<span class="cm">       @short_description: Example docs generated by gdbus-codegen</span>
<span class="cm">       @since: 2.30</span>

<span class="cm">       This D-Bus interface is used to describe a simple animal.</span>
<span class="cm">    --&gt;</span>
<span class="w">  </span><span class="nt">&lt;interface</span><span class="w"> </span><span class="na">name=</span><span class="s">"org.gtk.GDBus.Example.ObjectManager.Animal"</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- Mood: The mood of the animal.</span>
<span class="cm">         @since: 2.30</span>

<span class="cm">         Known values for this property include</span>
<span class="cm">         &lt;literal&gt;Happy&lt;/literal&gt; and &lt;literal&gt;Sad&lt;/literal&gt;. Use the</span>
<span class="cm">         org.gtk.GDBus.Example.ObjectManager.Animal.Poke() method to</span>
<span class="cm">         change this property.</span>

<span class="cm">         This property influences how often the animal jumps up and</span>
<span class="cm">         down, see the</span>
<span class="cm">         #org.gtk.GDBus.Example.ObjectManager.Animal::Jumped signal</span>
<span class="cm">         for more details.</span>
<span class="cm">    --&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">"Mood"</span><span class="w"> </span><span class="na">type=</span><span class="s">"s"</span><span class="w"> </span><span class="na">access=</span><span class="s">"read"</span><span class="nt">/&gt;</span>

<span class="w">    </span><span class="cm">&lt;!--</span>
<span class="cm">        Poke:</span>
<span class="cm">        @make_sad: Whether to make the animal sad.</span>
<span class="cm">        @make_happy: Whether to make the animal happy.</span>
<span class="cm">        @since: 2.30</span>

<span class="cm">        Method used to changing the mood of the animal. See also the</span>
<span class="cm">        #org.gtk.GDBus.Example.ObjectManager.Animal:Mood property.</span>
<span class="cm">      --&gt;</span>
<span class="w">    </span><span class="nt">&lt;method</span><span class="w"> </span><span class="na">name=</span><span class="s">"Poke"</span><span class="nt">&gt;</span>
<span class="w">      </span><span class="nt">&lt;arg</span><span class="w"> </span><span class="na">direction=</span><span class="s">"in"</span><span class="w"> </span><span class="na">type=</span><span class="s">"b"</span><span class="w"> </span><span class="na">name=</span><span class="s">"make_sad"</span><span class="nt">/&gt;</span>
<span class="w">      </span><span class="nt">&lt;arg</span><span class="w"> </span><span class="na">direction=</span><span class="s">"in"</span><span class="w"> </span><span class="na">type=</span><span class="s">"b"</span><span class="w"> </span><span class="na">name=</span><span class="s">"make_happy"</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/method&gt;</span>

<span class="w">    </span><span class="cm">&lt;!--</span>
<span class="cm">        Jumped:</span>
<span class="cm">        @height: Height, in meters, that the animal jumped.</span>
<span class="cm">        @since: 2.30</span>

<span class="cm">        Emitted when the animal decides to jump.</span>
<span class="cm">      --&gt;</span>
<span class="w">    </span><span class="nt">&lt;signal</span><span class="w"> </span><span class="na">name=</span><span class="s">"Jumped"</span><span class="nt">&gt;</span>
<span class="w">      </span><span class="nt">&lt;arg</span><span class="w"> </span><span class="na">type=</span><span class="s">"d"</span><span class="w"> </span><span class="na">name=</span><span class="s">"height"</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/signal&gt;</span>

<span class="w">    </span><span class="cm">&lt;!--</span>
<span class="cm">        Foo:</span>
<span class="cm">        Property with no &lt;quote&gt;since&lt;/quote&gt; annotation (should inherit the 2.30 from its containing interface).</span>
<span class="cm">      --&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">"Foo"</span><span class="w"> </span><span class="na">type=</span><span class="s">"s"</span><span class="w"> </span><span class="na">access=</span><span class="s">"read"</span><span class="nt">/&gt;</span>

<span class="w">    </span><span class="cm">&lt;!--</span>
<span class="cm">        Bar:</span>
<span class="cm">        @since: 2.36</span>
<span class="cm">        Property with a later &lt;quote&gt;since&lt;/quote&gt; annotation.</span>
<span class="cm">      --&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">"Bar"</span><span class="w"> </span><span class="na">type=</span><span class="s">"s"</span><span class="w"> </span><span class="na">access=</span><span class="s">"read"</span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/interface&gt;</span>

<span class="w">  </span><span class="cm">&lt;!-- org.gtk.GDBus.Example.ObjectManager.Cat:</span>
<span class="cm">       @short_description: More example docs generated by gdbus-codegen</span>

<span class="cm">       This D-Bus interface is used to describe a cat. Right now there</span>
<span class="cm">       are no properties, methods or signals associated with this</span>
<span class="cm">       interface so it is essentially a &lt;ulink</span>
<span class="cm">       url="http://en.wikipedia.org/wiki/Marker_interface_pattern"&gt;Marker</span>
<span class="cm">       Interface&lt;/ulink&gt;.</span>

<span class="cm">       Note that D-Bus objects implementing this interface also</span>
<span class="cm">       implement the #org.gtk.GDBus.Example.ObjectManager.Animal</span>
<span class="cm">       interface.</span>
<span class="cm">    --&gt;</span>
<span class="w">  </span><span class="nt">&lt;interface</span><span class="w"> </span><span class="na">name=</span><span class="s">"org.gtk.GDBus.Example.ObjectManager.Cat"</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;/interface&gt;</span>
<span class="nt">&lt;/node&gt;</span>
</code></pre></div>

<p>If this <span class="caps">XML</span> is processed like&nbsp;this</p>
<div class="codehilite"><pre><span></span><code>gdbus-codegen --interface-prefix org.gtk.GDBus.Example.ObjectManager. \
              --generate-c-code generated-code                        \
              --c-namespace Example                       \
              --c-generate-object-manager                 \
              --generate-docbook generated-docs                       \
              gdbus-example-objectmanager.xml
</code></pre></div>

<p>then two files generated-code.h and generated-code.c are generated.
Additionally, two <span class="caps">XML</span> files
generated-docs-org.gtk.GDBus.Example.ObjectManager.Animal and
generated-docs-org.gtk.GDBus.Example.ObjectManager.Cat with Docbook <span class="caps">XML</span> are&nbsp;generated.</p>
<p>While the contents of <code>generated-code.h</code> and <code>generated-code.c</code> are best described by the <code>gdbus-codegen</code> manual page, here’s a brief example of how this generated code can be&nbsp;used:</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">"gdbus-object-manager-example/objectmanager-gen.h"</span>

<span class="cm">/* ---------------------------------------------------------------------------------------------------- */</span>

<span class="k">static</span><span class="w"> </span><span class="n">GDBusObjectManagerServer</span><span class="w"> </span><span class="o">*</span><span class="n">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span><span class="w"> </span><span class="n">gboolean</span>
<span class="nf">on_animal_poke</span><span class="w"> </span><span class="p">(</span><span class="n">ExampleAnimal</span><span class="w">          </span><span class="o">*</span><span class="n">animal</span><span class="p">,</span>
<span class="w">                </span><span class="n">GDBusMethodInvocation</span><span class="w">  </span><span class="o">*</span><span class="n">invocation</span><span class="p">,</span>
<span class="w">                </span><span class="n">gboolean</span><span class="w">                </span><span class="n">make_sad</span><span class="p">,</span>
<span class="w">                </span><span class="n">gboolean</span><span class="w">                </span><span class="n">make_happy</span><span class="p">,</span>
<span class="w">                </span><span class="n">gpointer</span><span class="w">                </span><span class="n">user_data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">make_sad</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">make_happy</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">make_sad</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">make_happy</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">g_dbus_method_invocation_return_dbus_error</span><span class="w"> </span><span class="p">(</span><span class="n">invocation</span><span class="p">,</span>
<span class="w">                                                  </span><span class="s">"org.gtk.GDBus.Examples.ObjectManager.Error.Failed"</span><span class="p">,</span>
<span class="w">                                                  </span><span class="s">"Exactly one of make_sad or make_happy must be TRUE"</span><span class="p">);</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">make_sad</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">g_strcmp0</span><span class="w"> </span><span class="p">(</span><span class="n">example_animal_get_mood</span><span class="w"> </span><span class="p">(</span><span class="n">animal</span><span class="p">),</span><span class="w"> </span><span class="s">"Sad"</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="n">g_dbus_method_invocation_return_dbus_error</span><span class="w"> </span><span class="p">(</span><span class="n">invocation</span><span class="p">,</span>
<span class="w">                                                      </span><span class="s">"org.gtk.GDBus.Examples.ObjectManager.Error.SadAnimalIsSad"</span><span class="p">,</span>
<span class="w">                                                      </span><span class="s">"Sad animal is already sad"</span><span class="p">);</span>
<span class="w">          </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">      </span><span class="n">example_animal_set_mood</span><span class="w"> </span><span class="p">(</span><span class="n">animal</span><span class="p">,</span><span class="w"> </span><span class="s">"Sad"</span><span class="p">);</span>
<span class="w">      </span><span class="n">example_animal_complete_poke</span><span class="w"> </span><span class="p">(</span><span class="n">animal</span><span class="p">,</span><span class="w"> </span><span class="n">invocation</span><span class="p">);</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">make_happy</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">g_strcmp0</span><span class="w"> </span><span class="p">(</span><span class="n">example_animal_get_mood</span><span class="w"> </span><span class="p">(</span><span class="n">animal</span><span class="p">),</span><span class="w"> </span><span class="s">"Happy"</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="n">g_dbus_method_invocation_return_dbus_error</span><span class="w"> </span><span class="p">(</span><span class="n">invocation</span><span class="p">,</span>
<span class="w">                                                      </span><span class="s">"org.gtk.GDBus.Examples.ObjectManager.Error.HappyAnimalIsHappy"</span><span class="p">,</span>
<span class="w">                                                      </span><span class="s">"Happy animal is already happy"</span><span class="p">);</span>
<span class="w">          </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">      </span><span class="n">example_animal_set_mood</span><span class="w"> </span><span class="p">(</span><span class="n">animal</span><span class="p">,</span><span class="w"> </span><span class="s">"Happy"</span><span class="p">);</span>
<span class="w">      </span><span class="n">example_animal_complete_poke</span><span class="w"> </span><span class="p">(</span><span class="n">animal</span><span class="p">,</span><span class="w"> </span><span class="n">invocation</span><span class="p">);</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="n">g_assert_not_reached</span><span class="w"> </span><span class="p">();</span>

<span class="w"> </span><span class="nl">out</span><span class="p">:</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">G_DBUS_METHOD_INVOCATION_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">on_bus_acquired</span><span class="w"> </span><span class="p">(</span><span class="n">GDBusConnection</span><span class="w"> </span><span class="o">*</span><span class="n">connection</span><span class="p">,</span>
<span class="w">                 </span><span class="k">const</span><span class="w"> </span><span class="n">gchar</span><span class="w">     </span><span class="o">*</span><span class="n">name</span><span class="p">,</span>
<span class="w">                 </span><span class="n">gpointer</span><span class="w">         </span><span class="n">user_data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">ExampleObjectSkeleton</span><span class="w"> </span><span class="o">*</span><span class="n">object</span><span class="p">;</span>
<span class="w">  </span><span class="n">guint</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>

<span class="w">  </span><span class="n">g_print</span><span class="w"> </span><span class="p">(</span><span class="s">"Acquired a message bus connection</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/* Create a new org.freedesktop.DBus.ObjectManager rooted at /example/Animals */</span>
<span class="w">  </span><span class="n">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_dbus_object_manager_server_new</span><span class="w"> </span><span class="p">(</span><span class="s">"/example/Animals"</span><span class="p">);</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">gchar</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">;</span>
<span class="w">      </span><span class="n">ExampleAnimal</span><span class="w"> </span><span class="o">*</span><span class="n">animal</span><span class="p">;</span>

<span class="w">      </span><span class="cm">/* Create a new D-Bus object at the path /example/Animals/N where N is 000..009 */</span>
<span class="w">      </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_strdup_printf</span><span class="w"> </span><span class="p">(</span><span class="s">"/example/Animals/%03d"</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
<span class="w">      </span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">example_object_skeleton_new</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="w">      </span><span class="n">g_free</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

<span class="w">      </span><span class="cm">/* Make the newly created object export the interface</span>
<span class="cm">       * org.gtk.GDBus.Example.ObjectManager.Animal (note</span>
<span class="cm">       * that @object takes its own reference to @animal).</span>
<span class="cm">       */</span>
<span class="w">      </span><span class="n">animal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">example_animal_skeleton_new</span><span class="w"> </span><span class="p">();</span>
<span class="w">      </span><span class="n">example_animal_set_mood</span><span class="w"> </span><span class="p">(</span><span class="n">animal</span><span class="p">,</span><span class="w"> </span><span class="s">"Happy"</span><span class="p">);</span>
<span class="w">      </span><span class="n">example_object_skeleton_set_animal</span><span class="w"> </span><span class="p">(</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">animal</span><span class="p">);</span>
<span class="w">      </span><span class="n">g_object_unref</span><span class="w"> </span><span class="p">(</span><span class="n">animal</span><span class="p">);</span>

<span class="w">      </span><span class="cm">/* Cats are odd animals - so some of our objects implement the</span>
<span class="cm">       * org.gtk.GDBus.Example.ObjectManager.Cat interface in addition</span>
<span class="cm">       * to the .Animal interface</span>
<span class="cm">       */</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="n">ExampleCat</span><span class="w"> </span><span class="o">*</span><span class="n">cat</span><span class="p">;</span>
<span class="w">          </span><span class="n">cat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">example_cat_skeleton_new</span><span class="w"> </span><span class="p">();</span>
<span class="w">          </span><span class="n">example_object_skeleton_set_cat</span><span class="w"> </span><span class="p">(</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">cat</span><span class="p">);</span>
<span class="w">          </span><span class="n">g_object_unref</span><span class="w"> </span><span class="p">(</span><span class="n">cat</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">      </span><span class="cm">/* Handle Poke() D-Bus method invocations on the .Animal interface */</span>
<span class="w">      </span><span class="n">g_signal_connect</span><span class="w"> </span><span class="p">(</span><span class="n">animal</span><span class="p">,</span>
<span class="w">                        </span><span class="s">"handle-poke"</span><span class="p">,</span>
<span class="w">                        </span><span class="n">G_CALLBACK</span><span class="w"> </span><span class="p">(</span><span class="n">on_animal_poke</span><span class="p">),</span>
<span class="w">                        </span><span class="nb">NULL</span><span class="p">);</span><span class="w"> </span><span class="cm">/* user_data */</span>

<span class="w">      </span><span class="cm">/* Export the object (@manager takes its own reference to @object) */</span>
<span class="w">      </span><span class="n">g_dbus_object_manager_server_export</span><span class="w"> </span><span class="p">(</span><span class="n">manager</span><span class="p">,</span><span class="w"> </span><span class="n">G_DBUS_OBJECT_SKELETON</span><span class="w"> </span><span class="p">(</span><span class="n">object</span><span class="p">));</span>
<span class="w">      </span><span class="n">g_object_unref</span><span class="w"> </span><span class="p">(</span><span class="n">object</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/* Export all objects */</span>
<span class="w">  </span><span class="n">g_dbus_object_manager_server_set_connection</span><span class="w"> </span><span class="p">(</span><span class="n">manager</span><span class="p">,</span><span class="w"> </span><span class="n">connection</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">on_name_acquired</span><span class="w"> </span><span class="p">(</span><span class="n">GDBusConnection</span><span class="w"> </span><span class="o">*</span><span class="n">connection</span><span class="p">,</span>
<span class="w">                  </span><span class="k">const</span><span class="w"> </span><span class="n">gchar</span><span class="w">     </span><span class="o">*</span><span class="n">name</span><span class="p">,</span>
<span class="w">                  </span><span class="n">gpointer</span><span class="w">         </span><span class="n">user_data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">g_print</span><span class="w"> </span><span class="p">(</span><span class="s">"Acquired the name %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">on_name_lost</span><span class="w"> </span><span class="p">(</span><span class="n">GDBusConnection</span><span class="w"> </span><span class="o">*</span><span class="n">connection</span><span class="p">,</span>
<span class="w">              </span><span class="k">const</span><span class="w"> </span><span class="n">gchar</span><span class="w">     </span><span class="o">*</span><span class="n">name</span><span class="p">,</span>
<span class="w">              </span><span class="n">gpointer</span><span class="w">         </span><span class="n">user_data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">g_print</span><span class="w"> </span><span class="p">(</span><span class="s">"Lost the name %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>


<span class="n">gint</span>
<span class="nf">main</span><span class="w"> </span><span class="p">(</span><span class="n">gint</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">gchar</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">GMainLoop</span><span class="w"> </span><span class="o">*</span><span class="n">loop</span><span class="p">;</span>
<span class="w">  </span><span class="n">guint</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>

<span class="w">  </span><span class="n">loop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_main_loop_new</span><span class="w"> </span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">FALSE</span><span class="p">);</span>

<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_bus_own_name</span><span class="w"> </span><span class="p">(</span><span class="n">G_BUS_TYPE_SESSION</span><span class="p">,</span>
<span class="w">                       </span><span class="s">"org.gtk.GDBus.Examples.ObjectManager"</span><span class="p">,</span>
<span class="w">                       </span><span class="n">G_BUS_NAME_OWNER_FLAGS_ALLOW_REPLACEMENT</span><span class="w"> </span><span class="o">|</span>
<span class="w">                       </span><span class="n">G_BUS_NAME_OWNER_FLAGS_REPLACE</span><span class="p">,</span>
<span class="w">                       </span><span class="n">on_bus_acquired</span><span class="p">,</span>
<span class="w">                       </span><span class="n">on_name_acquired</span><span class="p">,</span>
<span class="w">                       </span><span class="n">on_name_lost</span><span class="p">,</span>
<span class="w">                       </span><span class="n">loop</span><span class="p">,</span>
<span class="w">                       </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">  </span><span class="n">g_main_loop_run</span><span class="w"> </span><span class="p">(</span><span class="n">loop</span><span class="p">);</span>

<span class="w">  </span><span class="n">g_bus_unown_name</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="w">  </span><span class="n">g_main_loop_unref</span><span class="w"> </span><span class="p">(</span><span class="n">loop</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>This, on the other hand, is a client-side application using generated&nbsp;code:</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">"gdbus-object-manager-example/objectmanager-gen.h"</span>

<span class="cm">/* ---------------------------------------------------------------------------------------------------- */</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">print_objects</span><span class="w"> </span><span class="p">(</span><span class="n">GDBusObjectManager</span><span class="w"> </span><span class="o">*</span><span class="n">manager</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">GList</span><span class="w"> </span><span class="o">*</span><span class="n">objects</span><span class="p">;</span>
<span class="w">  </span><span class="n">GList</span><span class="w"> </span><span class="o">*</span><span class="n">l</span><span class="p">;</span>

<span class="w">  </span><span class="n">g_print</span><span class="w"> </span><span class="p">(</span><span class="s">"Object manager at %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">g_dbus_object_manager_get_object_path</span><span class="w"> </span><span class="p">(</span><span class="n">manager</span><span class="p">));</span>
<span class="w">  </span><span class="n">objects</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_dbus_object_manager_get_objects</span><span class="w"> </span><span class="p">(</span><span class="n">manager</span><span class="p">);</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objects</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">ExampleObject</span><span class="w"> </span><span class="o">*</span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXAMPLE_OBJECT</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="w">      </span><span class="n">GList</span><span class="w"> </span><span class="o">*</span><span class="n">interfaces</span><span class="p">;</span>
<span class="w">      </span><span class="n">GList</span><span class="w"> </span><span class="o">*</span><span class="n">ll</span><span class="p">;</span>
<span class="w">      </span><span class="n">g_print</span><span class="w"> </span><span class="p">(</span><span class="s">" - Object at %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">g_dbus_object_get_object_path</span><span class="w"> </span><span class="p">(</span><span class="n">G_DBUS_OBJECT</span><span class="w"> </span><span class="p">(</span><span class="n">object</span><span class="p">)));</span>

<span class="w">      </span><span class="n">interfaces</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_dbus_object_get_interfaces</span><span class="w"> </span><span class="p">(</span><span class="n">G_DBUS_OBJECT</span><span class="w"> </span><span class="p">(</span><span class="n">object</span><span class="p">));</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">interfaces</span><span class="p">;</span><span class="w"> </span><span class="n">ll</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"> </span><span class="n">ll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="n">GDBusInterface</span><span class="w"> </span><span class="o">*</span><span class="n">interface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">G_DBUS_INTERFACE</span><span class="w"> </span><span class="p">(</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="w">          </span><span class="n">g_print</span><span class="w"> </span><span class="p">(</span><span class="s">"   - Interface %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">g_dbus_interface_get_info</span><span class="w"> </span><span class="p">(</span><span class="n">interface</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

<span class="w">          </span><span class="cm">/* Note that @interface is really a GDBusProxy instance - and additionally also</span>
<span class="cm">           * an ExampleAnimal or ExampleCat instance - either of these can be used to</span>
<span class="cm">           * invoke methods on the remote object. For example, the generated function</span>
<span class="cm">           *</span>
<span class="cm">           *  void example_animal_call_poke_sync (ExampleAnimal  *proxy,</span>
<span class="cm">           *                                      gboolean        make_sad,</span>
<span class="cm">           *                                      gboolean        make_happy,</span>
<span class="cm">           *                                      GCancellable   *cancellable,</span>
<span class="cm">           *                                      GError        **error);</span>
<span class="cm">           *</span>
<span class="cm">           * can be used to call the Poke() D-Bus method on the .Animal interface.</span>
<span class="cm">           * Additionally, the generated function</span>
<span class="cm">           *</span>
<span class="cm">           *  const gchar *example_animal_get_mood (ExampleAnimal *object);</span>
<span class="cm">           *</span>
<span class="cm">           * can be used to get the value of the :Mood property.</span>
<span class="cm">           */</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="n">g_list_free_full</span><span class="w"> </span><span class="p">(</span><span class="n">interfaces</span><span class="p">,</span><span class="w"> </span><span class="n">g_object_unref</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="n">g_list_free_full</span><span class="w"> </span><span class="p">(</span><span class="n">objects</span><span class="p">,</span><span class="w"> </span><span class="n">g_object_unref</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">on_object_added</span><span class="w"> </span><span class="p">(</span><span class="n">GDBusObjectManager</span><span class="w"> </span><span class="o">*</span><span class="n">manager</span><span class="p">,</span>
<span class="w">                 </span><span class="n">GDBusObject</span><span class="w">        </span><span class="o">*</span><span class="n">object</span><span class="p">,</span>
<span class="w">                 </span><span class="n">gpointer</span><span class="w">            </span><span class="n">user_data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">gchar</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">;</span>
<span class="w">  </span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_dbus_object_manager_client_get_name_owner</span><span class="w"> </span><span class="p">(</span><span class="n">G_DBUS_OBJECT_MANAGER_CLIENT</span><span class="w"> </span><span class="p">(</span><span class="n">manager</span><span class="p">));</span>
<span class="w">  </span><span class="n">g_print</span><span class="w"> </span><span class="p">(</span><span class="s">"Added object at %s (owner %s)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">g_dbus_object_get_object_path</span><span class="w"> </span><span class="p">(</span><span class="n">object</span><span class="p">),</span><span class="w"> </span><span class="n">owner</span><span class="p">);</span>
<span class="w">  </span><span class="n">g_free</span><span class="w"> </span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">on_object_removed</span><span class="w"> </span><span class="p">(</span><span class="n">GDBusObjectManager</span><span class="w"> </span><span class="o">*</span><span class="n">manager</span><span class="p">,</span>
<span class="w">                   </span><span class="n">GDBusObject</span><span class="w">        </span><span class="o">*</span><span class="n">object</span><span class="p">,</span>
<span class="w">                   </span><span class="n">gpointer</span><span class="w">            </span><span class="n">user_data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">gchar</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">;</span>
<span class="w">  </span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_dbus_object_manager_client_get_name_owner</span><span class="w"> </span><span class="p">(</span><span class="n">G_DBUS_OBJECT_MANAGER_CLIENT</span><span class="w"> </span><span class="p">(</span><span class="n">manager</span><span class="p">));</span>
<span class="w">  </span><span class="n">g_print</span><span class="w"> </span><span class="p">(</span><span class="s">"Removed object at %s (owner %s)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">g_dbus_object_get_object_path</span><span class="w"> </span><span class="p">(</span><span class="n">object</span><span class="p">),</span><span class="w"> </span><span class="n">owner</span><span class="p">);</span>
<span class="w">  </span><span class="n">g_free</span><span class="w"> </span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">on_notify_name_owner</span><span class="w"> </span><span class="p">(</span><span class="n">GObject</span><span class="w">    </span><span class="o">*</span><span class="n">object</span><span class="p">,</span>
<span class="w">                      </span><span class="n">GParamSpec</span><span class="w"> </span><span class="o">*</span><span class="n">pspec</span><span class="p">,</span>
<span class="w">                      </span><span class="n">gpointer</span><span class="w">    </span><span class="n">user_data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">GDBusObjectManagerClient</span><span class="w"> </span><span class="o">*</span><span class="n">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">G_DBUS_OBJECT_MANAGER_CLIENT</span><span class="w"> </span><span class="p">(</span><span class="n">object</span><span class="p">);</span>
<span class="w">  </span><span class="n">gchar</span><span class="w"> </span><span class="o">*</span><span class="n">name_owner</span><span class="p">;</span>

<span class="w">  </span><span class="n">name_owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_dbus_object_manager_client_get_name_owner</span><span class="w"> </span><span class="p">(</span><span class="n">manager</span><span class="p">);</span>
<span class="w">  </span><span class="n">g_print</span><span class="w"> </span><span class="p">(</span><span class="s">"name-owner: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">name_owner</span><span class="p">);</span>
<span class="w">  </span><span class="n">g_free</span><span class="w"> </span><span class="p">(</span><span class="n">name_owner</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">on_interface_proxy_properties_changed</span><span class="w"> </span><span class="p">(</span><span class="n">GDBusObjectManagerClient</span><span class="w"> </span><span class="o">*</span><span class="n">manager</span><span class="p">,</span>
<span class="w">                                       </span><span class="n">GDBusObjectProxy</span><span class="w">         </span><span class="o">*</span><span class="n">object_proxy</span><span class="p">,</span>
<span class="w">                                       </span><span class="n">GDBusProxy</span><span class="w">               </span><span class="o">*</span><span class="n">interface_proxy</span><span class="p">,</span>
<span class="w">                                       </span><span class="n">GVariant</span><span class="w">                 </span><span class="o">*</span><span class="n">changed_properties</span><span class="p">,</span>
<span class="w">                                       </span><span class="k">const</span><span class="w"> </span><span class="n">gchar</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w">       </span><span class="o">*</span><span class="n">invalidated_properties</span><span class="p">,</span>
<span class="w">                                       </span><span class="n">gpointer</span><span class="w">                  </span><span class="n">user_data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">GVariantIter</span><span class="w"> </span><span class="n">iter</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">gchar</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">;</span>
<span class="w">  </span><span class="n">GVariant</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="p">;</span>
<span class="w">  </span><span class="n">gchar</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">;</span>

<span class="w">  </span><span class="n">g_print</span><span class="w"> </span><span class="p">(</span><span class="s">"Properties Changed on %s:</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">g_dbus_object_get_object_path</span><span class="w"> </span><span class="p">(</span><span class="n">G_DBUS_OBJECT</span><span class="w"> </span><span class="p">(</span><span class="n">object_proxy</span><span class="p">)));</span>
<span class="w">  </span><span class="n">g_variant_iter_init</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="p">,</span><span class="w"> </span><span class="n">changed_properties</span><span class="p">);</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">g_variant_iter_next</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="p">,</span><span class="w"> </span><span class="s">"{&amp;sv}"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">value</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_variant_print</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">TRUE</span><span class="p">);</span>
<span class="w">      </span><span class="n">g_print</span><span class="w"> </span><span class="p">(</span><span class="s">"  %s -&gt; %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">);</span>
<span class="w">      </span><span class="n">g_variant_unref</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="w">      </span><span class="n">g_free</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">gint</span>
<span class="nf">main</span><span class="w"> </span><span class="p">(</span><span class="n">gint</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">gchar</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">GDBusObjectManager</span><span class="w"> </span><span class="o">*</span><span class="n">manager</span><span class="p">;</span>
<span class="w">  </span><span class="n">GMainLoop</span><span class="w"> </span><span class="o">*</span><span class="n">loop</span><span class="p">;</span>
<span class="w">  </span><span class="n">GError</span><span class="w"> </span><span class="o">*</span><span class="n">error</span><span class="p">;</span>
<span class="w">  </span><span class="n">gchar</span><span class="w"> </span><span class="o">*</span><span class="n">name_owner</span><span class="p">;</span>

<span class="w">  </span><span class="n">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="n">loop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="w">  </span><span class="n">loop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_main_loop_new</span><span class="w"> </span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">FALSE</span><span class="p">);</span>

<span class="w">  </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="n">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">example_object_manager_client_new_for_bus_sync</span><span class="w"> </span><span class="p">(</span><span class="n">G_BUS_TYPE_SESSION</span><span class="p">,</span>
<span class="w">                                                            </span><span class="n">G_DBUS_OBJECT_MANAGER_CLIENT_FLAGS_NONE</span><span class="p">,</span>
<span class="w">                                                            </span><span class="s">"org.gtk.GDBus.Examples.ObjectManager"</span><span class="p">,</span>
<span class="w">                                                            </span><span class="s">"/example/Animals"</span><span class="p">,</span>
<span class="w">                                                            </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="cm">/* GCancellable */</span>
<span class="w">                                                            </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">manager</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">g_printerr</span><span class="w"> </span><span class="p">(</span><span class="s">"Error getting object manager client: %s"</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
<span class="w">      </span><span class="n">g_error_free</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="n">name_owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_dbus_object_manager_client_get_name_owner</span><span class="w"> </span><span class="p">(</span><span class="n">G_DBUS_OBJECT_MANAGER_CLIENT</span><span class="w"> </span><span class="p">(</span><span class="n">manager</span><span class="p">));</span>
<span class="w">  </span><span class="n">g_print</span><span class="w"> </span><span class="p">(</span><span class="s">"name-owner: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">name_owner</span><span class="p">);</span>
<span class="w">  </span><span class="n">g_free</span><span class="w"> </span><span class="p">(</span><span class="n">name_owner</span><span class="p">);</span>

<span class="w">  </span><span class="n">print_objects</span><span class="w"> </span><span class="p">(</span><span class="n">manager</span><span class="p">);</span>

<span class="w">  </span><span class="n">g_signal_connect</span><span class="w"> </span><span class="p">(</span><span class="n">manager</span><span class="p">,</span>
<span class="w">                    </span><span class="s">"notify::name-owner"</span><span class="p">,</span>
<span class="w">                    </span><span class="n">G_CALLBACK</span><span class="w"> </span><span class="p">(</span><span class="n">on_notify_name_owner</span><span class="p">),</span>
<span class="w">                    </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">  </span><span class="n">g_signal_connect</span><span class="w"> </span><span class="p">(</span><span class="n">manager</span><span class="p">,</span>
<span class="w">                    </span><span class="s">"object-added"</span><span class="p">,</span>
<span class="w">                    </span><span class="n">G_CALLBACK</span><span class="w"> </span><span class="p">(</span><span class="n">on_object_added</span><span class="p">),</span>
<span class="w">                    </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">  </span><span class="n">g_signal_connect</span><span class="w"> </span><span class="p">(</span><span class="n">manager</span><span class="p">,</span>
<span class="w">                    </span><span class="s">"object-removed"</span><span class="p">,</span>
<span class="w">                    </span><span class="n">G_CALLBACK</span><span class="w"> </span><span class="p">(</span><span class="n">on_object_removed</span><span class="p">),</span>
<span class="w">                    </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">  </span><span class="n">g_signal_connect</span><span class="w"> </span><span class="p">(</span><span class="n">manager</span><span class="p">,</span>
<span class="w">                    </span><span class="s">"interface-proxy-properties-changed"</span><span class="p">,</span>
<span class="w">                    </span><span class="n">G_CALLBACK</span><span class="w"> </span><span class="p">(</span><span class="n">on_interface_proxy_properties_changed</span><span class="p">),</span>
<span class="w">                    </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">  </span><span class="n">g_main_loop_run</span><span class="w"> </span><span class="p">(</span><span class="n">loop</span><span class="p">);</span>

<span class="w"> </span><span class="nl">out</span><span class="p">:</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">manager</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="n">g_object_unref</span><span class="w"> </span><span class="p">(</span><span class="n">manager</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">loop</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="n">g_main_loop_unref</span><span class="w"> </span><span class="p">(</span><span class="n">loop</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
    </div>
  </section>
</section>


    



    <section id="search" class="content hidden"></section>

    <footer>
    
    </footer>
  </div>



</body><!-- Mirrored from docs.gtk.org/gio/migrating-gdbus.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 31 Jan 2025 08:38:15 GMT --></html>